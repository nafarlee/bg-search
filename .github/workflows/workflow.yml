---
name: CI
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - uses: actions/setup-node@v1
        with:
          node-version: 10.16.3

      - name: Install dependencies
        run: npm ci

      - name: Test
        run: npm t

      - name: Install gcloud
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" \
            | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" \
            | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt update
          sudo apt install -y google-cloud-sdk

      - name: Create db-credentials.json
        env:
          DATABASE_CREDENTIALS: ${{ secrets.DATABASE_CREDENTIALS }}
        run: echo "$DATABASE_CREDENTIALS" | base64 -d > db-credentials.json

      - name: Create google-credentials.json
        run: echo "$GOOGLE_CREDENTIALS" > google-credentials.json
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Deploy
        run: |
          ls
          gcloud auth activate-service-account \
            --key-file=google-credentials.json
          npm run deploy
